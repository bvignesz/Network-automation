---
- name: Zscaler URL Filtering Automation
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    zscaler_username: "{{ lookup('env', 'ZSCALER_USERNAME') }}"
    zscaler_password: "{{ lookup('env', 'ZSCALER_PASSWORD') }}"
    zscaler_api_key: "{{ lookup('env', 'ZSCALER_API_KEY') }}"
    zscaler_cloud: "{{ lookup('env', 'ZSCALER_CLOUD') | default('zscalerbeta', true) }}"
    
    raw_operation: "{{ operation | default('list', true) }}"
    selected_rule_name: "{{ rule_name | default('', true) }}"
    selected_url_to_block: "{{ block_url | default('', true) }}"
    selected_url_category: "{{ url_category | default('', true) }}"
    selected_rule_action: "{{ rule_action | default('', true) }}"
    selected_report_format: "{{ report_format | default('table', true) }}"
    
    operation_map:
      "list": "list"
      "List All Rules": "list"
      "add-category": "add-category"
      "Add URL Category to Rule": "add-category"
      "block-url": "block-url"
      "Block URL": "block-url"
      "update-action": "update-action"
      "Update Rule Action": "update-action"
    
    selected_operation: "{{ operation_map[raw_operation] | default('list') }}"
    
    script_path: "{{ playbook_dir }}/zscaler_url_automation.py"
    reports_dir: "{{ playbook_dir }}/reports"
    
  pre_tasks:
    - name: DEBUG - Show received variables
      debug:
        msg:
          - "Raw operation received: '{{ raw_operation }}'"
          - "Normalized operation: '{{ selected_operation }}'"
          - "Rule name: '{{ selected_rule_name }}'"
          - "URL to block: '{{ selected_url_to_block }}'"
      tags: always
    
    - name: Validate required environment variables
      fail:
        msg: "Missing required environment variable: {{ item }}"
      when: lookup('env', item) == ''
      loop:
        - ZSCALER_USERNAME
        - ZSCALER_PASSWORD
        - ZSCALER_API_KEY
      tags: always
      
    - name: Create reports directory
      file:
        path: "{{ reports_dir }}"
        state: directory
        mode: '0755'
      tags: always
      
    - name: Validate Python dependencies
      command: python3 -c "import zscaler"
      register: python_check
      failed_when: false
      changed_when: false
      tags: always
      
    - name: Install Python dependencies if needed
      pip:
        requirements: "{{ playbook_dir }}/requirements.txt"
        executable: pip3
      when: python_check.rc != 0
      tags: always
      
  tasks:
    - name: List all URL filtering rules
      command: >
        python3 {{ script_path }}
        --list-rules
        --format {{ selected_report_format }}
      environment:
        ZSCALER_USERNAME: "{{ zscaler_username }}"
        ZSCALER_PASSWORD: "{{ zscaler_password }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
      register: list_output
      when: selected_operation == 'list'
      changed_when: false
      tags: list
        
    - name: Display list output
      debug:
        msg: "{{ list_output.stdout_lines }}"
      when: selected_operation == 'list' and list_output is defined and list_output.stdout_lines is defined
      tags: list
        
    - name: Validate inputs for add-category operation
      fail:
        msg: "Both 'rule_name' and 'url_category' are required for add-category operation"
      when: 
        - selected_operation == 'add-category'
        - (selected_rule_name == '' or selected_url_category == '')
      tags: add-category
      
    - name: Add URL category to existing rule
      command: >
        python3 {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --add-category "{{ selected_url_category }}"
      environment:
        ZSCALER_USERNAME: "{{ zscaler_username }}"
        ZSCALER_PASSWORD: "{{ zscaler_password }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
      register: add_category_output
      when: selected_operation == 'add-category'
      tags: add-category
      
    - name: Display add-category output
      debug:
        msg: "{{ add_category_output.stdout_lines }}"
      when: selected_operation == 'add-category' and add_category_output is defined and add_category_output.stdout_lines is defined
      tags: add-category
      
    - name: Validate inputs for block-url operation
      fail:
        msg: "Both 'rule_name' and 'block_url' are required. Got rule_name='{{ selected_rule_name }}', block_url='{{ selected_url_to_block }}'"
      when: 
        - selected_operation == 'block-url'
        - (selected_rule_name == '' or selected_url_to_block == '')
      tags: block-url
      
    - name: Block URL in specified rule
      command: >
        python3 {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --block-url "{{ selected_url_to_block }}"
      environment:
        ZSCALER_USERNAME: "{{ zscaler_username }}"
        ZSCALER_PASSWORD: "{{ zscaler_password }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
      register: block_url_output
      when: 
        - selected_operation == 'block-url'
        - selected_rule_name != ''
        - selected_url_to_block != ''
      tags: block-url
      
    - name: Display block-url output
      debug:
        msg: "{{ block_url_output.stdout_lines }}"
      when: selected_operation == 'block-url' and block_url_output is defined and block_url_output.stdout_lines is defined
      tags: block-url
      
    - name: Validate inputs for update-action operation
      fail:
        msg: "Both 'rule_name' and 'rule_action' are required for update-action operation"
      when: 
        - selected_operation == 'update-action'
        - (selected_rule_name == '' or selected_rule_action == '')
      tags: update-action
      
    - name: Update rule action
      command: >
        python3 {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --action {{ selected_rule_action }}
      environment:
        ZSCALER_USERNAME: "{{ zscaler_username }}"
        ZSCALER_PASSWORD: "{{ zscaler_password }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
      register: update_action_output
      when: selected_operation == 'update-action'
      tags: update-action
      
    - name: Display update-action output
      debug:
        msg: "{{ update_action_output.stdout_lines }}"
      when: selected_operation == 'update-action' and update_action_output is defined and update_action_output.stdout_lines is defined
      tags: update-action
      
  post_tasks:
    - name: Find generated reports
      find:
        paths: "{{ reports_dir }}"
        patterns: "zscaler_rules_*.csv,zscaler_rules_*.json"
        age: "-1h"
      register: recent_reports
      when: selected_report_format in ['csv', 'json']
      tags: always
      
    - name: Display report locations
      debug:
        msg: "Report saved: {{ item.path }}"
      loop: "{{ recent_reports.files | default([]) }}"
      when: recent_reports is defined and recent_reports.files is defined and recent_reports.files | length > 0
      tags: always
      
    - name: Summary
      debug:
        msg: 
          - "================================="
          - "Zscaler Automation Completed"
          - "Operation: {{ selected_operation }}"
          - "Timestamp: {{ ansible_date_time.iso8601 }}"
          - "================================="
      tags: always
