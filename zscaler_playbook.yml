---
- name: Zscaler URL Filtering Automation (Cloud Service API Key)
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    # Semaphore venv paths - CRITICAL for proper execution
    venv_python: "/opt/semaphore/apps/ansible/11.1.0/venv/bin/python3"
    venv_pip: "/opt/semaphore/apps/ansible/11.1.0/venv/bin/python3 -m pip"
    
    # Script location
    script_path: "/tmp/semaphore/project_1/repository_3_template_11/zscaler_url_automation.py"
    
    # Zscaler credentials for Cloud Service API Key authentication
    zscaler_api_key: "{{ lookup('env', 'ZSCALER_API_KEY') }}"
    zscaler_cloud: "zscalerbeta"  # Hardcoded - change if using different cloud
    zscaler_base_url: "{{ lookup('env', 'ZSCALER_BASE_URL') | default('https://zsapi.zscalerbeta.net/api/v1', true) }}"
    
    # Operation name mapping (converts display names to internal codes)
    operation_map:
      "List All Rules": "list"
      "list": "list"
      "Add URL Category": "add-category"
      "add-category": "add-category"
      "Block URL": "block-url"
      "block-url": "block-url"
      "Update Rule Action": "update-action"
      "update-action": "update-action"
    
    # Operation parameters (from Semaphore survey/form)
    selected_operation: "{{ operation_map[operation | default('list')] | default('list') }}"
    selected_rule_name: "{{ rule_name | default('') }}"
    selected_category_id: "{{ category_id | default('') }}"
    selected_url_to_block: "{{ url_to_block | default('') }}"
    selected_action: "{{ action | default('') }}"
    selected_report_format: "{{ report_format | default('table') }}"

  tasks:
    # ============================================================================
    # PREREQUISITE CHECKS AND SETUP
    # ============================================================================
    
    - name: Validate required credentials
      assert:
        that:
          - zscaler_api_key | length > 0
          - zscaler_cloud | length > 0
        fail_msg: "Missing required Zscaler credentials. Check ZSCALER_API_KEY and ZSCALER_CLOUD environment variables."
        success_msg: "All required credentials are present"
      tags: always

    - name: Check if automation script exists
      stat:
        path: "{{ script_path }}"
      register: script_stat
      tags: always

    - name: Fail if script is missing
      fail:
        msg: "Automation script not found at {{ script_path }}"
      when: not script_stat.stat.exists
      tags: always

    - name: Install Zscaler SDK
      command: "{{ venv_pip }} install zscaler-sdk-python --upgrade --quiet"
      register: pip_install
      changed_when: "'Successfully installed' in pip_install.stdout"
      failed_when: pip_install.rc != 0
      tags: always

    - name: Verify Zscaler SDK
      command: "{{ venv_python }} -c \"from zscaler.oneapi_client import LegacyZIAClient; print('SDK_OK')\""
      register: sdk_check
      failed_when: sdk_check.rc != 0
      changed_when: false
      tags: always

    - name: Display SDK verification result
      debug:
        msg: "Zscaler SDK verified successfully"
      when: sdk_check.rc == 0
      tags: always

    # ============================================================================
    # OPERATION: LIST ALL RULES
    # ============================================================================
    
    - name: Debug environment variables
      debug:
        msg:
          - "API Key length: {{ zscaler_api_key | length }}"
          - "Cloud value: {{ zscaler_cloud }}"
          - "Base URL: {{ zscaler_base_url }}"
      tags: always
    
    - name: List all URL filtering rules
      command: >
        {{ venv_python }} {{ script_path }}
        --list-rules
        --format {{ selected_report_format }}
      environment:
        PATH: "/opt/semaphore/apps/ansible/11.1.0/venv/bin:{{ ansible_env.PATH }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
        ZSCALER_BASE_URL: "{{ zscaler_base_url }}"
      register: list_output
      when: selected_operation == 'list'
      tags: always

    - name: Display rules list
      debug:
        msg: "{{ list_output.stdout_lines }}"
      when: 
        - selected_operation == 'list'
        - list_output is defined
        - list_output.stdout_lines is defined
      tags: always

    # ============================================================================
    # OPERATION: ADD URL CATEGORY TO RULE
    # ============================================================================
    
    - name: Validate parameters for add-category operation
      assert:
        that:
          - selected_rule_name | length > 0
          - selected_category_id | length > 0
        fail_msg: "Both rule_name and category_id are required for add-category operation"
      when: selected_operation == 'add-category'
      tags: always

    - name: Add URL category to rule
      command: >
        {{ venv_python }} {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --add-category "{{ selected_category_id }}"
      environment:
        PATH: "/opt/semaphore/apps/ansible/11.1.0/venv/bin:{{ ansible_env.PATH }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
        ZSCALER_BASE_URL: "{{ zscaler_base_url }}"
      register: add_category_output
      when: 
        - selected_operation == 'add-category'
        - selected_rule_name | length > 0
        - selected_category_id | length > 0
      tags: always

    - name: Display add category result
      debug:
        msg: "{{ add_category_output.stdout_lines }}"
      when: 
        - selected_operation == 'add-category'
        - add_category_output is defined
        - add_category_output.stdout_lines is defined
      tags: always

    # ============================================================================
    # OPERATION: BLOCK URL IN SPECIFIC RULE
    # ============================================================================
    
    - name: Validate parameters for block-url operation
      assert:
        that:
          - selected_rule_name | length > 0
          - selected_url_to_block | length > 0
        fail_msg: "Both rule_name and url_to_block are required for block-url operation"
      when: selected_operation == 'block-url'
      tags: always

    - name: Block URL in specified rule
      command: >
        {{ venv_python }} {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --block-url "{{ selected_url_to_block }}"
      environment:
        PATH: "/opt/semaphore/apps/ansible/11.1.0/venv/bin:{{ ansible_env.PATH }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
        ZSCALER_BASE_URL: "{{ zscaler_base_url }}"
      register: block_url_output
      when:
        - selected_operation == 'block-url'
        - selected_rule_name | length > 0
        - selected_url_to_block | length > 0
      tags: always

    - name: Display block URL result
      debug:
        msg: "{{ block_url_output.stdout_lines }}"
      when: 
        - selected_operation == 'block-url'
        - block_url_output is defined
        - block_url_output.stdout_lines is defined
      tags: always

    # ============================================================================
    # OPERATION: UPDATE RULE ACTION
    # ============================================================================
    
    - name: Validate parameters for update-action operation
      assert:
        that:
          - selected_rule_name | length > 0
          - selected_action | length > 0
          - selected_action in ['ALLOW', 'BLOCK', 'CAUTION']
        fail_msg: "Both rule_name and valid action (ALLOW/BLOCK/CAUTION) are required for update-action operation"
      when: selected_operation == 'update-action'
      tags: always

    - name: Update rule action
      command: >
        {{ venv_python }} {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --update-action "{{ selected_action }}"
      environment:
        PATH: "/opt/semaphore/apps/ansible/11.1.0/venv/bin:{{ ansible_env.PATH }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
        ZSCALER_BASE_URL: "{{ zscaler_base_url }}"
      register: update_action_output
      when:
        - selected_operation == 'update-action'
        - selected_rule_name | length > 0
        - selected_action | length > 0
      tags: always

    - name: Display update action result
      debug:
        msg: "{{ update_action_output.stdout_lines }}"
      when: 
        - selected_operation == 'update-action'
        - update_action_output is defined
        - update_action_output.stdout_lines is defined
      tags: always

    # ============================================================================
    # FINAL SUMMARY
    # ============================================================================
    
    - name: Operation summary
      debug:
        msg: |
          ========================================
          Zscaler URL Filtering Automation Summary
          ========================================
          Operation: {{ selected_operation }}
          Rule Name: {{ selected_rule_name | default('N/A') }}
          Category ID: {{ selected_category_id | default('N/A') }}
          URL to Block: {{ selected_url_to_block | default('N/A') }}
          Action: {{ selected_action | default('N/A') }}
          Status: {% if (list_output is defined and list_output is not skipped and list_output.rc == 0) or (add_category_output is defined and add_category_output is not skipped and add_category_output.rc == 0) or (block_url_output is defined and block_url_output is not skipped and block_url_output.rc == 0) or (update_action_output is defined and update_action_output is not skipped and update_action_output.rc == 0) %}SUCCESS{% else %}COMPLETED{% endif %}
          ========================================
      tags: always
