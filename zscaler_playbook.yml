---
# =============================================================================
# Zscaler URL Filtering Automation Playbook (FIXED)
# =============================================================================

- name: Zscaler URL Filtering Automation (Official SDK)
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    # Semaphore venv paths
    venv_python: "/opt/semaphore/apps/ansible/11.1.0/venv/bin/python3"
    venv_pip: "/opt/semaphore/apps/ansible/11.1.0/venv/bin/python3 -m pip"
    
    # Script location
    script_path: "{{ playbook_dir }}/zscaler_url_automation.py"
    
    # Zscaler credentials from environment variables
    zia_username: "{{ lookup('env', 'ZIA_USERNAME') }}"
    zia_password: "{{ lookup('env', 'ZIA_PASSWORD') }}"
    zia_api_key: "{{ lookup('env', 'ZIA_API_KEY') }}"
    zia_cloud: "{{ lookup('env', 'ZIA_CLOUD') | default('zscalerbeta', true) }}"
    
    # Raw operation from Semaphore survey - normalize it
    raw_operation: "{{ operation | default('list') | lower | replace(' ', '-') | trim }}"
    
    # Operation parameters from Semaphore survey (matching YOUR variable names)
    selected_rule_name: "{{ rule_name | default('') | trim }}"
    selected_category_id: "{{ url_category | default('') | trim }}"
    selected_url_to_block: "{{ block_url | default('') | trim }}"
    selected_action: "{{ rule_action | default('') | trim }}"
    selected_report_format: "{{ report_format | default('table') | trim }}"

  tasks:
    # ============================================================================
    # PREREQUISITE CHECKS
    # ============================================================================
    
    - name: Display configuration info
      debug:
        msg: |
          ========================================
          Zscaler URL Filtering Automation
          ========================================
          Cloud: {{ zia_cloud }}
          Username: {{ zia_username | default('NOT SET', true) }}
          API Key Set: {{ 'Yes' if zia_api_key | length > 0 else 'No' }}
          Operation: {{ raw_operation }}
          Rule Name: {{ selected_rule_name }}
          URL to Block: {{ selected_url_to_block }}
          ========================================
      tags: always

    - name: Validate required credentials
      assert:
        that:
          - zia_username | length > 0
          - zia_password | length > 0
          - zia_api_key | length > 0
        fail_msg: "Missing required Zscaler credentials!"
        success_msg: "âœ… All required credentials are present"
      tags: always

    - name: Check if automation script exists
      stat:
        path: "{{ script_path }}"
      register: script_stat
      tags: always

    - name: Fail if script is missing
      fail:
        msg: "Automation script not found at {{ script_path }}"
      when: not script_stat.stat.exists
      tags: always

    - name: Install zscaler-sdk-python package
      command: "{{ venv_pip }} install zscaler-sdk-python --quiet --upgrade"
      register: pip_install
      changed_when: "'Successfully installed' in pip_install.stdout"
      failed_when: pip_install.rc != 0
      tags: always

    - name: Verify SDK installation
      command: "{{ venv_python }} -c 'from zscaler.oneapi_client import LegacyZIAClient; print(\"SDK OK\")'"
      register: sdk_check
      changed_when: false
      failed_when: sdk_check.rc != 0
      tags: always

    # ============================================================================
    # OPERATION: LIST ALL RULES
    # ============================================================================
    
    - name: List all URL filtering rules
      command: >
        {{ venv_python }} {{ script_path }}
        --list-rules
        --format {{ selected_report_format }}
      environment:
        ZIA_USERNAME: "{{ zia_username }}"
        ZIA_PASSWORD: "{{ zia_password }}"
        ZIA_API_KEY: "{{ zia_api_key }}"
        ZIA_CLOUD: "{{ zia_cloud }}"
      register: list_output
      when: raw_operation == 'list' or raw_operation == 'list-all-rules' or raw_operation == 'list-rules'
      tags: always

    - name: Display rules list
      debug:
        msg: "{{ list_output.stdout_lines }}"
      when: 
        - list_output is defined
        - list_output.stdout_lines is defined
        - list_output is not skipped
      tags: always

    # ============================================================================
    # OPERATION: LIST URL CATEGORIES
    # ============================================================================
    
    - name: List all URL categories
      command: >
        {{ venv_python }} {{ script_path }}
        --list-categories
        --format {{ selected_report_format }}
      environment:
        ZIA_USERNAME: "{{ zia_username }}"
        ZIA_PASSWORD: "{{ zia_password }}"
        ZIA_API_KEY: "{{ zia_api_key }}"
        ZIA_CLOUD: "{{ zia_cloud }}"
      register: categories_output
      when: raw_operation == 'list-categories'
      tags: always

    - name: Display categories list
      debug:
        msg: "{{ categories_output.stdout_lines }}"
      when: 
        - categories_output is defined
        - categories_output.stdout_lines is defined
        - categories_output is not skipped
      tags: always

    # ============================================================================
    # OPERATION: ADD URL CATEGORY TO RULE
    # ============================================================================
    
    - name: Add URL category to rule
      command: >
        {{ venv_python }} {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --add-category "{{ selected_category_id }}"
      environment:
        ZIA_USERNAME: "{{ zia_username }}"
        ZIA_PASSWORD: "{{ zia_password }}"
        ZIA_API_KEY: "{{ zia_api_key }}"
        ZIA_CLOUD: "{{ zia_cloud }}"
      register: add_category_output
      when: 
        - raw_operation == 'add-category'
        - selected_rule_name | length > 0
        - selected_category_id | length > 0
      tags: always

    - name: Display add category result
      debug:
        msg: "{{ add_category_output.stdout_lines }}"
      when: 
        - add_category_output is defined
        - add_category_output.stdout_lines is defined
        - add_category_output is not skipped
      tags: always

    # ============================================================================
    # OPERATION: BLOCK URL IN SPECIFIC RULE
    # ============================================================================
    
    - name: Block URL in specified rule
      command: >
        {{ venv_python }} {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --block-url "{{ selected_url_to_block }}"
      environment:
        ZIA_USERNAME: "{{ zia_username }}"
        ZIA_PASSWORD: "{{ zia_password }}"
        ZIA_API_KEY: "{{ zia_api_key }}"
        ZIA_CLOUD: "{{ zia_cloud }}"
      register: block_url_output
      when:
        - raw_operation == 'block-url'
        - selected_rule_name | length > 0
        - selected_url_to_block | length > 0
      tags: always

    - name: Display block URL result
      debug:
        msg: "{{ block_url_output.stdout_lines }}"
      when: 
        - block_url_output is defined
        - block_url_output.stdout_lines is defined
        - block_url_output is not skipped
      tags: always

    # ============================================================================
    # OPERATION: UPDATE RULE ACTION
    # ============================================================================
    
    - name: Update rule action
      command: >
        {{ venv_python }} {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --update-action "{{ selected_action }}"
      environment:
        ZIA_USERNAME: "{{ zia_username }}"
        ZIA_PASSWORD: "{{ zia_password }}"
        ZIA_API_KEY: "{{ zia_api_key }}"
        ZIA_CLOUD: "{{ zia_cloud }}"
      register: update_action_output
      when:
        - raw_operation == 'update-action'
        - selected_rule_name | length > 0
        - selected_action | length > 0
      tags: always

    - name: Display update action result
      debug:
        msg: "{{ update_action_output.stdout_lines }}"
      when: 
        - update_action_output is defined
        - update_action_output.stdout_lines is defined
        - update_action_output is not skipped
      tags: always

    # ============================================================================
    # FINAL SUMMARY
    # ============================================================================
    
    - name: Operation summary
      debug:
        msg: |
          ========================================
          Zscaler Automation Summary
          ========================================
          Operation: {{ raw_operation }}
          Rule Name: {{ selected_rule_name | default('N/A') }}
          URL to Block: {{ selected_url_to_block | default('N/A') }}
          Category: {{ selected_category_id | default('N/A') }}
          Action: {{ selected_action | default('N/A') }}
          ========================================
      tags: always
