---
- name: Zscaler URL Filtering Automation
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    zscaler_username: "{{ lookup('env', 'ZSCALER_USERNAME') }}"
    zscaler_password: "{{ lookup('env', 'ZSCALER_PASSWORD') }}"
    zscaler_api_key: "{{ lookup('env', 'ZSCALER_API_KEY') }}"
    zscaler_cloud: "{{ lookup('env', 'ZSCALER_CLOUD') | default('zscalerbeta', true) }}"
    
    raw_operation: "{{ operation | default('list', true) }}"
    selected_rule_name: "{{ rule_name | default('', true) }}"
    selected_url_to_block: "{{ block_url | default('', true) }}"
    selected_url_category: "{{ url_category | default('', true) }}"
    selected_rule_action: "{{ rule_action | default('', true) }}"
    selected_report_format: "{{ report_format | default('table', true) }}"
    
    operation_map:
      "list": "list"
      "List All Rules": "list"
      "add-category": "add-category"
      "Add URL Category to Rule": "add-category"
      "block-url": "block-url"
      "Block URL": "block-url"
      "update-action": "update-action"
      "Update Rule Action": "update-action"
    
    selected_operation: "{{ operation_map[raw_operation] | default('list') }}"
    
    script_path: "{{ playbook_dir }}/zscaler_url_automation.py"
    reports_dir: "{{ playbook_dir }}/reports"
    
  pre_tasks:
    - name: DEBUG - Show ALL received variables
      debug:
        msg:
          - "============= INPUT DEBUG ============="
          - "Raw operation: '{{ raw_operation }}'"
          - "Normalized operation: '{{ selected_operation }}'"
          - "Rule name: '{{ selected_rule_name }}'"
          - "URL to block: '{{ selected_url_to_block }}'"
          - "URL category: '{{ selected_url_category }}'"
          - "Rule action: '{{ selected_rule_action }}'"
          - "Report format: '{{ selected_report_format }}'"
          - "============= ENV DEBUG ============="
          - "ZSCALER_USERNAME set: {{ zscaler_username | length > 0 }}"
          - "ZSCALER_PASSWORD set: {{ zscaler_password | length > 0 }}"
          - "ZSCALER_API_KEY set: {{ zscaler_api_key | length > 0 }}"
          - "ZSCALER_CLOUD: '{{ zscaler_cloud }}'"
      tags: always
    
    - name: Check if Python script exists
      stat:
        path: "{{ script_path }}"
      register: script_stat
      tags: always
      
    - name: Fail if script does not exist
      fail:
        msg: "Python script not found at {{ script_path }}"
      when: not script_stat.stat.exists
      tags: always
    
    - name: Validate required environment variables
      fail:
        msg: "Missing required environment variable: {{ item }}"
      when: lookup('env', item) == ''
      loop:
        - ZSCALER_USERNAME
        - ZSCALER_PASSWORD
        - ZSCALER_API_KEY
      tags: always
      
    - name: Create reports directory
      file:
        path: "{{ reports_dir }}"
        state: directory
        mode: '0755'
      tags: always
    
    - name: Install Zscaler SDK
      command: pip3 install zscaler-sdk-python --upgrade --quiet
      register: pip_install
      changed_when: "'Successfully installed' in pip_install.stdout"
      failed_when: false
      tags: always
      
    - name: Verify Zscaler SDK installation
      command: python3 -c "from zscaler import ZIAClientHelper; print('SDK OK')"
      register: sdk_check
      failed_when: false
      changed_when: false
      tags: always
      
    - name: DEBUG - SDK verification
      debug:
        msg:
          - "SDK check return code: {{ sdk_check.rc }}"
          - "SDK check stdout: {{ sdk_check.stdout | default('none') }}"
          - "SDK check stderr: {{ sdk_check.stderr | default('none') }}"
      tags: always
      
    - name: Warn if SDK check failed (will try alternative import in script)
      debug:
        msg: "⚠️ Primary SDK import failed, script will try alternative methods"
      when: sdk_check.rc != 0
      tags: always
      
  tasks:
    - name: List all URL filtering rules
      command: >
        python3 {{ script_path }}
        --list-rules
        --format {{ selected_report_format }}
      environment:
        ZSCALER_USERNAME: "{{ zscaler_username }}"
        ZSCALER_PASSWORD: "{{ zscaler_password }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
      register: list_output
      when: selected_operation == 'list'
      changed_when: false
      tags: list
        
    - name: Display list output
      debug:
        msg: "{{ list_output.stdout_lines | default(['No output']) }}"
      when: 
        - selected_operation == 'list'
        - list_output is defined
      tags: list
        
    - name: Validate inputs for add-category operation
      fail:
        msg: "Both 'rule_name' and 'url_category' are required for add-category operation"
      when: 
        - selected_operation == 'add-category'
        - (selected_rule_name | length == 0) or (selected_url_category | length == 0)
      tags: add-category
      
    - name: Add URL category to existing rule
      command: >
        python3 {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --add-category "{{ selected_url_category }}"
      environment:
        ZSCALER_USERNAME: "{{ zscaler_username }}"
        ZSCALER_PASSWORD: "{{ zscaler_password }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
      register: add_category_output
      when: 
        - selected_operation == 'add-category'
        - selected_rule_name | length > 0
        - selected_url_category | length > 0
      tags: add-category
      
    - name: Display add-category output
      debug:
        msg: "{{ add_category_output.stdout_lines | default(['No output']) }}"
      when: 
        - selected_operation == 'add-category'
        - add_category_output is defined
      tags: add-category
      
    - name: DEBUG - Block URL conditions check
      debug:
        msg:
          - "============= BLOCK URL CONDITIONS ============="
          - "Condition 1 - operation == 'block-url': {{ selected_operation == 'block-url' }}"
          - "Condition 2 - rule_name length > 0: {{ selected_rule_name | length > 0 }}"
          - "Condition 3 - url_to_block length > 0: {{ selected_url_to_block | length > 0 }}"
          - "ALL conditions met: {{ (selected_operation == 'block-url') and (selected_rule_name | length > 0) and (selected_url_to_block | length > 0) }}"
      when: selected_operation == 'block-url'
      tags: block-url
      
    - name: Validate inputs for block-url operation
      fail:
        msg: "Both 'rule_name' and 'block_url' are required. Got rule_name='{{ selected_rule_name }}', block_url='{{ selected_url_to_block }}'"
      when: 
        - selected_operation == 'block-url'
        - (selected_rule_name | length == 0) or (selected_url_to_block | length == 0)
      tags: block-url
      
    - name: Block URL in specified rule
      command: >
        python3 {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --block-url "{{ selected_url_to_block }}"
      environment:
        ZSCALER_USERNAME: "{{ zscaler_username }}"
        ZSCALER_PASSWORD: "{{ zscaler_password }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
      register: block_url_output
      when: 
        - selected_operation == 'block-url'
        - selected_rule_name | length > 0
        - selected_url_to_block | length > 0
      tags: block-url
      
    - name: Display block-url output
      debug:
        msg: "{{ block_url_output.stdout_lines | default(['No output']) }}"
      when: 
        - selected_operation == 'block-url'
        - block_url_output is defined
      tags: block-url
      
    - name: Validate inputs for update-action operation
      fail:
        msg: "Both 'rule_name' and 'rule_action' are required for update-action operation"
      when: 
        - selected_operation == 'update-action'
        - (selected_rule_name | length == 0) or (selected_rule_action | length == 0)
      tags: update-action
      
    - name: Update rule action
      command: >
        python3 {{ script_path }}
        --rule-name "{{ selected_rule_name }}"
        --action {{ selected_rule_action }}
      environment:
        ZSCALER_USERNAME: "{{ zscaler_username }}"
        ZSCALER_PASSWORD: "{{ zscaler_password }}"
        ZSCALER_API_KEY: "{{ zscaler_api_key }}"
        ZSCALER_CLOUD: "{{ zscaler_cloud }}"
      register: update_action_output
      when: 
        - selected_operation == 'update-action'
        - selected_rule_name | length > 0
        - selected_rule_action | length > 0
      tags: update-action
      
    - name: Display update-action output
      debug:
        msg: "{{ update_action_output.stdout_lines | default(['No output']) }}"
      when: 
        - selected_operation == 'update-action'
        - update_action_output is defined
      tags: update-action
      
  post_tasks:
    - name: Find generated reports
      find:
        paths: "{{ reports_dir }}"
        patterns: "zscaler_rules_*.csv,zscaler_rules_*.json"
        age: "-1h"
      register: recent_reports
      when: selected_report_format in ['csv', 'json']
      tags: always
      
    - name: Display report locations
      debug:
        msg: "Report saved: {{ item.path }}"
      loop: "{{ recent_reports.files | default([]) }}"
      when: recent_reports is defined and recent_reports.files is defined and recent_reports.files | length > 0
      tags: always
      
    - name: Summary
      debug:
        msg: 
          - "================================="
          - "Zscaler Automation Completed"
          - "Operation: {{ selected_operation }}"
          - "Timestamp: {{ ansible_date_time.iso8601 }}"
          - "================================="
      tags: always
